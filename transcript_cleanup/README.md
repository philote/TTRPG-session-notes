# Transcript Cleanup Tools

This directory contains Phase 1 improved tools for processing and cleaning TTRPG session transcripts generated by Whisper.

## Phase 1 Improved Scripts

### ðŸ†• **transcript_cleanup_v2.py** - Main Processing Pipeline
The modernized transcript processor with Phase 1 improvements.

**Features:**
- Unified configuration system (JSON + environment variables)
- Professional logging with colored output
- Shared utilities for reliable processing
- Comprehensive error handling and progress tracking
- Command-line interface with argument parsing

**Usage:**
```bash
# Using JSON configuration file
python transcript_cleanup_v2.py --config my_config.json

# Using environment variables
export TTRPG_BASE_PATH="/path/to/transcripts"
export TTRPG_SESSION_NAME="my_session"
python transcript_cleanup_v2.py

# Override settings via command line
python transcript_cleanup_v2.py --base-path /path/to/files --log-level DEBUG

# Quick test with sample data (run from project root)
python transcript_cleanup_v2.py --base-path transcripts-test-data
```

### ðŸ†• **json_text_replace_v2.py** - Text Replacement Tool
Improved text replacement tool for correcting transcription errors.

**Features:**
- Auto-detection of input files
- Smart replacement statistics and logging
- Flexible file path handling
- Better error reporting

**Usage:**
```bash
# Auto-detect input files in current directory
python json_text_replace_v2.py

# Specify files explicitly
python json_text_replace_v2.py \
  --input transcript.txt \
  --replacements replacements.json \
  --output corrected_transcript.txt

# Process with custom configuration
python json_text_replace_v2.py --config my_config.json --log-level INFO
```


## Configuration

### Modern Configuration (Phase 1)

#### JSON Configuration File Example
```json
{
  "whisper": {
    "model": "turbo",
    "condition_on_previous_text": false,
    "compression_ratio_threshold": 1.8,
    "fp16": true,
    "language": "en"
  },
  "cleanup": {
    "session_name": "my_campaign",
    "part": "session_01", 
    "base_path": "/path/to/transcripts",
    "short_duplicate_text_length": 4,
    "merge_threshold": 0.01,
    "short_text_length": 1,
    "remove_silence_gibberish": true,
    "max_length": 50000,
    "overlap": 3000,
    "replacements_file": "merge_replacements.json"
  },
  "name_mappings": {
    "ephson": "Player: Joe (Character: The Shepherd)",
    "thebookersmith": "Player: Booker (Character: Ale-ore)",
    "turtleherder": "Player: Liam (Character: Mortimer)"
  },
  "silence_patterns": [
    "you", "You", "Thank you", "Hmm", "hmm", "Uh", "uh", 
    "Yeah", "yeah", "Okay", "okay", "Um", "um"
  ]
}
```

#### Environment Variables
```bash
# Session settings
export TTRPG_SESSION_NAME="my_campaign"
export TTRPG_SESSION_PART="session_01"
export TTRPG_BASE_PATH="/path/to/transcripts"

# Processing settings
export TTRPG_MAX_LENGTH=50000
export TTRPG_OVERLAP=3000

# Whisper settings
export TTRPG_WHISPER_MODEL="turbo"
export TTRPG_WHISPER_LANGUAGE="en"
export TTRPG_WHISPER_FP16="true"

# Logging
export TTRPG_LOG_LEVEL="INFO"
export TTRPG_COLORED_OUTPUT="true"
```

### Replacements File Format
Place `merge_replacements.json` in your session directory:
```json
{
  "CorrectName": ["mishear1", "mishear2", "variant3"],
  "Gandalf": ["gandolf", "gandulf", "gandif"],
  "Shepherd": ["shepard", "shepherd", "sheppard"],
  "PlayerName": ["playername", "player name"]
}
```

## Processing Pipeline

### 1. Individual File Processing
For each TSV file:
- âœ… Load TSV data into DataFrame
- âœ… Remove duplicate short text entries (â‰¤4 characters)
- âœ… Merge adjacent segments (within 0.01s threshold)
- âœ… Remove very short text entries (â‰¤1 character)
- âœ… Remove silence gibberish patterns
- âœ… Apply speaker name mapping
- âœ… Save as processed CSV

### 2. Speaker Merging
- âœ… Combine all processed files chronologically by timestamp
- âœ… Group consecutive segments by same speaker
- âœ… Merge adjacent speaker segments into cohesive blocks
- âœ… Save merged CSV file

### 3. Text Replacement
- âœ… Load replacements from JSON file
- âœ… Apply case-insensitive replacements
- âœ… Log replacement statistics
- âœ… Track total corrections made

### 4. Final Output Generation
- âœ… Create formatted transcript with speaker labels
- âœ… Split large transcripts with overlap for AI processing
- âœ… Generate complete transcript file
- âœ… Report file statistics and processing summary

## Input Files

The scripts expect TSV files generated by Whisper with these columns:
- `start` - Start timestamp (milliseconds)
- `end` - End timestamp (milliseconds) 
- `text` - Transcribed dialogue text

Example TSV content:
```tsv
start	end	text
0	1400	Hello everyone
1400	3200	Welcome to our session
3200	5800	Let's begin the adventure
```

## Output Files

### Generated Files
- `*_processed.csv` - Individual cleaned speaker files
- `*_merged.csv` - Combined chronological transcript
- `Session_*_Final_COMPLETE.txt` - Final readable transcript
- `Session_*_Final_part_*.txt` - Split parts (if needed)

### File Structure Example
```
my_session/
â”œâ”€â”€ 1-player1.tsv              # Input from Whisper
â”œâ”€â”€ 2-player2.tsv              # Input from Whisper
â”œâ”€â”€ merge_replacements.json    # Replacements config
â”œâ”€â”€ 1-player1.processed.csv    # Processed individual file
â”œâ”€â”€ 2-player2.processed.csv    # Processed individual file  
â”œâ”€â”€ my_session__processed.csv  # Combined processed data
â”œâ”€â”€ my_session__merged.csv     # Merged speaker segments
â””â”€â”€ Session_complete_Final_COMPLETE.txt  # Final transcript
```

## Advanced Usage

### Custom Processing Parameters
```bash
python transcript_cleanup_v2.py \
  --base-path /path/to/transcripts \
  --session-name "epic_campaign" \
  --part "session_05" \
  --log-level DEBUG
```

### Batch Processing Multiple Sessions
```bash
#!/bin/bash
for session in session_01 session_02 session_03; do
  echo "Processing $session..."
  python transcript_cleanup_v2.py \
    --base-path "/campaigns/epic_quest/$session" \
    --session-name "epic_quest" \
    --part "$session"
done
```

### Integration with Transcription
```bash
# 1. Transcribe audio files
python ../transcribe/whisper_transcribe.py audio_files/ --output-dir session_data/

# 2. Create replacements file
echo '{"Gandalf": ["gandolf"], "Frodo": ["froto"]}' > session_data/merge_replacements.json

# 3. Process transcripts
python transcript_cleanup_v2.py --base-path session_data/

# 4. Apply additional replacements if needed
python json_text_replace_v2.py --input session_data/Session_complete_Final_COMPLETE.txt
```

## Troubleshooting

### Common Issues

**1. No TSV files found**
```bash
# Ensure TSV files are in the base path
ls /path/to/transcripts/*.tsv

# Check base path configuration
python transcript_cleanup_v2.py --base-path /path/to/transcripts --log-level DEBUG
```

**2. Configuration errors**
```bash
# Check current configuration status
python config_migration.py --check

# Validate JSON configuration
python -c "import json; print(json.load(open('config.json')))"
```

**3. Permission issues**
```bash
# Ensure write permissions for output directory
chmod 755 /path/to/transcripts
```

**4. Import errors with shared utilities**
```bash
# Ensure you're running from the project root
cd /path/to/TTRPG-session-notes
python transcript_cleanup/transcript_cleanup_v2.py --help
```

### Debugging

Enable debug logging to see detailed processing information:
```bash
python transcript_cleanup_v2.py --log-level DEBUG --base-path test_data/
```

This will show:
- File discovery and loading details
- Processing step-by-step progress
- Text replacement statistics
- File I/O operations
- Error details with stack traces

## Upgrading from Legacy Scripts

The `OLD/` directory contains the original scripts for reference. To use the new Phase 1 improvements:

1. **Use the v2 scripts directly:**
   ```bash
   python transcript_cleanup_v2.py --base-path your_session_directory
   ```

2. **Create configuration as needed:**
   ```bash
   # Option A: Use environment variables
   export TTRPG_BASE_PATH="/path/to/your/sessions"
   
   # Option B: Create JSON config
   echo '{"cleanup": {"base_path": "/path/to/sessions"}}' > config.json
   ```

### Benefits of v2 Scripts
- âœ… Professional logging instead of colorama prints
- âœ… Environment variable configuration support  
- âœ… Better error handling and recovery
- âœ… Comprehensive progress tracking
- âœ… Flexible configuration options
- âœ… Full test coverage and reliability

---

## Legacy Scripts (OLD/)

The `OLD/` directory contains the original scripts for reference:
- `transcript_cleanup.py` - Original processing script
- `json_text_replace.py` - Original text replacement
- `config.py` - Original configuration system
- `default_*.py` and `*.json` - Original defaults

These are preserved for backward compatibility but are no longer actively maintained. **Use the v2 scripts for new projects.**